## Discord News Bot

<img width="1919" height="948" alt="image" src="https://github.com/user-attachments/assets/26ac1848-ea55-48a9-b8b2-1953b9e8c166" />


Веб-панель и Discord-бот для публикации новостей: поддержка вложений, кнопок, планирования и Embed (встроенных сообщений).  
Документ описывает установку, создание `.env` и типичные операции.

---

## Содержание

- [Требования](#требования)  
- [Где разместить `.env`](#где-разместить-env)  
- [Пример `web/.env`](#пример-webenv)  
- [Как сгенерировать `ADMIN_PASSWORD_HASH`](#как-сгенерировать-admin_password_hash)  
- [Установка и запуск](#установка-и-запуск)  
- [Использование панели](#использование-панели)  
- [Формат цвета для Embed](#формат-цвета-для-embed)  
- [Работа с Git и `.env`](#работа-с-git-и-env)  
- [Отладка — частые проблемы](#отладка---частые-проблемы)  
- [Безопасность](#безопасность)

---

## Требования

- Node.js 18+  
- npm  
- Токен Discord-бота (создан в Discord Developer Portal)

---

## Где разместить `.env`

Файл с переменными окружения должен находиться в папке `web/` проекта:

web/.env


`bot/index.js` загружает `.env` через `require('dotenv').config({ path: path.join(__dirname, '../web/.env') })`, поэтому файл должен быть в `web/`.

---

## Пример `web/.env`

Создайте файл `web/.env` и положите туда (заполните свои значения):

```env
# Токен Discord-бота (обязательно)
BOT_TOKEN=your_discord_bot_token_here

# ID сервера (guild) — используется для получения каналов/ролей (рекомендуется)
GUILD_ID=123456789012345678

# Секрет сессии Express (обязательно)
SESSION_SECRET=some_long_random_secret_value

# Хэш пароля администратора (обязательно) — см. инструкцию как сгенерировать
ADMIN_PASSWORD_HASH=$2a$10$...

# Порт веб-сервера (необязательно, по умолчанию 30000)
PORT=30000

# (Необязательно) NODE_ENV=production
```
Важно: не храните этот файл в публичных репозиториях.
Как сгенерировать ADMIN_PASSWORD_HASH

Используется bcrypt. Выполните одну из команд в корне проекта:
Вариант 1 — если bcryptjs установлен в проекте:

node -e "console.log(require('bcryptjs').hashSync('ваш_пароль_здесь', 10))"

Вариант 2 — через npx (если не установлен локально):

npx -y bcryptjs -e "console.log(require('bcryptjs').hashSync('ваш_пароль_здесь', 10))"

Скопируйте вывод (bcrypt-хэш) в web/.env как значение ADMIN_PASSWORD_HASH.
Установка и запуск

    Установите зависимости:

npm install

    Создайте web/.env (см. выше).

    Запустите:

npm run start
# или явно
node web/server.js

При старте web/server.js импортирует bot/index.js, который должен логиниться в Discord с BOT_TOKEN. Таким образом командой выше запускается веб-панель и бот вместе.
Использование панели

    Откройте браузер: http://localhost:30000 (или PORT из .env).

    Войдите по паролю (тот, хэш которого вы поместили в ADMIN_PASSWORD_HASH).

    На dashboard:

        Выберите канал.

        При желании укажите роль для упоминания (роле будет отправлен ping).

        Напишите текст новости (поддерживается Markdown — на фронте используется marked для предпросмотра).

        Вложения: можно загрузить до 10 файлов, максимум 10 MB каждый.

        Кнопки: добавьте до 5 ссылок (Label + URL).

        Запланировать отправку: включите и выберите дату/время (UTC локальное время браузера).

        Embed: включите чекбокс Отправить как Embed, задайте Заголовок и цвет. Текст в поле основного контента попадёт в embed.description (и не будет дублироваться в обычном сообщении — чтобы избежать двойной публикации). Если указана роль — она будет отправлена как отдельный content (чтобы сохранялся ping).

Формат цвета для Embed

Цвет можно выбрать через color-picker или ввести hex (#RRGGBB). Бот поддерживает:

    hex строки (#2f3136 или 2f3136)

    числовые значения (например 7506394)

Работа с Git и .env

    Добавьте web/.env в .gitignore, чтобы файл не отслеживался:

echo "web/.env" >> .gitignore
git add .gitignore
git commit -m "chore: add web/.env to .gitignore"

    Если .env уже попал в репозиторий — удалите его из индекса (файл останется локально):

git rm --cached web/.env
git commit -m "chore: stop tracking web/.env"

Отладка — частые проблемы

    cannot find module 'passport'
    Это означает, что в server.js есть код, требующий passport. В текущей версии server.js passport не используется. Убедитесь, что вы запускаете правильный web/server.js (тот, что без OAuth) и что нет старых копий. Если в проекте остался server.js с passport — удалите или используйте версию без passport.

    Текст дублируется при отправке Embed
    В последних правках бот специально не дублирует текст: если отправляете embed, обычный content не отправляется (только упоминание роли, если оно задано). Если хотите, чтобы текст дублировался и как content, и как embed, добавьте чекбокс «Include content with embed» и пропишите логику на фронте/сервере.

    Планирование не работает

        Проверьте, что scheduledTime в форме приходит в будущем.

        В логах бота ищите ошибки (bot/index.js выводит ошибки при отправке/планировании).

        Таймеры используют setTimeout и ограничение ~24 дня (2147483647 ms).

    CSRF ошибки
    Убедитесь, что формой отправляете скрытое поле _csrf (шаблон это делает автоматически) и что заголовок X-CSRF-Token передаётся (front уже добавляет его, если доступен).

Безопасность

    Не выкладывайте web/.env в публичный репозиторий.

    Для production используйте HTTPS и установите cookie.secure = true в настройках сессии.

    SESSION_SECRET должен быть длинным и случайным.

    Проверьте, что бот имеет минимально необходимые права в гильдии (View Channels, Send Messages, Embed Links, Attach Files).

Полезные команды

    Запустить локально:

npm run start

    Сгенерировать bcrypt-хэш:

node -e "console.log(require('bcryptjs').hashSync('ваш_пароль', 10))"


