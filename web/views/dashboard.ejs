<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Панель управления - Discord News Bot</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css" rel="stylesheet" />
    <link href="/css/style.css" rel="stylesheet" />
</head>
<body>
<nav class="navbar navbar-dark bg-dark navbar-expand-lg">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">
            <i class="bi bi-megaphone"></i> Discord News Bot
        </span>
        <div class="navbar-nav ms-auto">
            <span class="navbar-text me-3">
                <img src="<%= user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png` : '/img/default-avatar.png' %>"
                     width="30" height="30" class="rounded-circle me-2">
                <%= user.username %>
            </span>
            <span class="navbar-text me-3">
                <i class="bi bi-discord"></i> Сервер: <strong><%= guildName %></strong>
            </span>
            <a href="/logout" class="btn btn-outline-light btn-sm">
                <i class="bi bi-box-arrow-right"></i> Выйти
            </a>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4">
    <div class="row">
        <!-- Левая колонка - Форма -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <i class="bi bi-pencil-square"></i> Создание новости
                </div>
                <div class="card-body">
                    <form id="newsForm" enctype="multipart/form-data">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="channel" class="form-label">
                                    <i class="bi bi-hash"></i> Канал
                                </label>
                                <div class="input-with-icon">
                                    <i class="bi bi-chat-dots"></i>
                                    <select class="form-select" id="channel" name="channel" required>
                                        <option value="">Выберите канал...</option>
                                        <% channels.forEach(channel => { %>
                                            <option value="<%= channel.id %>"><%= channel.name %></option>
                                        <% }); %>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="role" class="form-label">
                                    <i class="bi bi-at"></i> Упоминание роли
                                </label>
                                <div class="input-with-icon">
                                    <i class="bi bi-people"></i>
                                    <select class="form-select" id="role" name="role">
                                        <option value="">Не упоминать</option>
                                        <option value="everyone">@everyone</option>
                                        <% roles.forEach(role => { %>
                                            <option value="<%= role.id %>" style="color: <%= role.color %>;">@<%= role.name %></option>
                                        <% }); %>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="content" class="form-label">
                                <i class="bi bi-chat-text"></i> Текст новости
                            </label>
                            <textarea class="form-control" id="content" name="content" rows="6" placeholder="Введите текст новости..."></textarea>
                            <div class="form-text">
                                <i class="bi bi-markdown"></i> Поддерживается Markdown форматирование
                            </div>

                            <div class="form-check form-switch mt-3">
                                <input class="form-check-input" type="checkbox" id="useEmbed" name="useEmbed">
                                <label class="form-check-label" for="useEmbed">
                                    <i class="bi bi-layout-text-sidebar"></i> Отправить как Embed
                                </label>
                            </div>

                            <div id="embedFields" style="display:none;" class="mt-3">
                                <label for="embedTitle" class="form-label">
                                    <i class="bi bi-type"></i> Заголовок Embed
                                </label>
                                <input type="text" class="form-control mb-2" id="embedTitle" placeholder="Введите заголовок...">

                                <label for="embedColor" class="form-label">
                                    <i class="bi bi-palette"></i> Цвет Embed
                                </label>
                                <div class="input-group mb-2">
                                    <input type="color" id="embedColor" class="form-control form-control-color" value="#5865f2" title="Выберите цвет">
                                    <input type="text" id="embedColorHex" class="form-control" placeholder="#5865f2" value="#5865f2">
                                </div>
                                <div class="form-text">В embed отправится: <code>title</code> и <code>description</code> (из поля «Текст новости»)</div>
                            </div>
                        </div>

                        <!-- Блок выбора позиции вложений -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-arrow-up-down"></i> Позиция вложений
                            </label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="attachmentPosition" id="positionStart" value="start" checked>
                                <label class="form-check-label" for="positionStart">
                                    <i class="bi bi-arrow-up"></i> В начале сообщения
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="attachmentPosition" id="positionEnd" value="end">
                                <label class="form-check-label" for="positionEnd">
                                    <i class="bi bi-arrow-down"></i> В конце сообщения
                                </label>
                            </div>
                            <div class="form-text">Выберите, где должны отображаться прикрепленные файлы</div>
                        </div>

                        <div class="mb-4">
                            <label for="attachments" class="form-label">
                                <i class="bi bi-paperclip"></i> Вложения
                            </label>
                            <input class="form-control" type="file" id="attachments" name="attachments" multiple>
                            <div class="form-text">Максимум 10 файлов, не более 10MB каждый</div>
                            <div id="filePreview" class="mt-2"></div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-ui-buttons"></i> Кнопки
                            </label>
                            <div id="buttonsContainer">
                                <div class="button-item mb-2">
                                    <div class="input-group">
                                        <input type="text" class="form-control" placeholder="Текст кнопки" maxlength="80">
                                        <input type="url" class="form-control" placeholder="https://example.com">
                                        <button type="button" class="btn btn-danger remove-btn"><i class="bi bi-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-secondary mt-2" id="addButton">
                                <i class="bi bi-plus-circle"></i> Добавить кнопку
                            </button>
                            <div class="form-text">Максимум 5 кнопок</div>
                        </div>

                        <!-- Выбор часового пояса -->
                        <div class="mb-4">
                            <label for="timezone" class="form-label">
                                <i class="bi bi-globe"></i> Часовой пояс
                            </label>
                            <select class="form-select" id="timezone" name="timezone" required>
                                <% timezones.forEach(tz => { %>
                                    <option value="<%= tz.value %>" <%= (user.timezone === tz.value) ? 'selected' : '' %>><%= tz.name %></option>
                                <% }); %>
                            </select>
                            <div class="form-text">Выберите ваш часовой пояс для корректного отображения времени</div>
                        </div>

                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="schedule" name="schedule">
                                <label class="form-check-label" for="schedule">
                                    <i class="bi bi-clock"></i> Запланировать отправку
                                </label>
                            </div>
                            <div id="scheduleDate" style="display: none;" class="mt-2">
                                <label for="scheduledTime" class="form-label">
                                    <i class="bi bi-calendar-event"></i> Дата и время отправки
                                </label>
                                <input type="datetime-local" class="form-control" id="scheduledTime" name="scheduledTime">
                                <div class="form-text">Время будет показано в выбранном часовом поясе</div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success w-100 py-3">
                            <i class="bi bi-send"></i> Опубликовать новость
                        </button>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Правая колонка -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <i class="bi bi-eye"></i> Live-предпросмотр
                </div>
                <div class="card-body">
                    <div id="previewContent" class="discord-preview">
                        <p class="text-muted">Здесь будет отображаться предпросмотр вашего сообщения...</p>
                    </div>
                </div>
            </div>

            <div class="card shadow">
                <div class="card-header">
                    <i class="bi bi-clock-history"></i> История отправок
                </div>
                <div class="card-body">
                    <div class="history-list" id="historyList">
                        <% if (history.length === 0) { %>
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-inbox display-4"></i>
                                <p class="mt-2">Нет отправленных сообщений</p>
                            </div>
                        <% } else { %>
                            <% history.forEach(item => { %>
                                <div class="history-item">
                                    <div class="history-meta">
                                        <div class="history-status">
                                            <% if (item.sent) { %>
                                                <span class="badge bg-success">Отправлено</span>
                                            <% } else if (item.canceled) { %>
                                                <span class="badge bg-secondary">Отменено</span>
                                            <% } else { %>
                                                <span class="badge bg-warning">Запланировано</span>
                                            <% } %>
                                            <h6 class="mb-0 ms-2">
                                                <%= (item.content || '').substring(0, 50) + ((item.content || '').length > 50 ? '...' : '') %>
                                            </h6>
                                        </div>
                                        <small class="history-date" data-utc="<%= item.createdAt %>">
                                            <%= item.createdAtLocal %> (<%= item.userTimezone %>)
                                        </small>
                                    </div>

                                    <div class="history-content">
                                        <p class="mb-1 text-muted">
                                            Канал: <%= item.channelId %><br>
                                            <% if (item.scheduledTimeLocal && !item.sent && !item.canceled) { %>
                                                Запланировано на: <span data-utc="<%= item.scheduledTime %>"><%= item.scheduledTimeLocal %> (<%= item.userTimezone %>)</span>
                                            <% } %>
                                        </p>
                                    </div>

                                    <!-- Блок с информацией об авторе -->
                                    <% if (item.author) { %>
                                        <div class="author-info">
                                            <div class="d-flex align-items-center">
                                                <% if (item.author.avatar) { %>
                                                    <img src="https://cdn.discordapp.com/avatars/<%= item.author.id %>/<%= item.author.avatar %>.png"
                                                         class="author-avatar" alt="Аватар <%= item.author.username %>">
                                                <% } else { %>
                                                    <div class="avatar-placeholder">
                                                        <i class="bi bi-person"></i>
                                                    </div>
                                                <% } %>
                                                <span class="author-name"><%= item.author.username %></span>
                                                <% if (item.author.timezone && item.author.timezone !== item.userTimezone) { %>
                                                    <span class="author-timezone ms-2">(Часовой пояс: <%= item.author.timezone %>)</span>
                                                <% } %>
                                            </div>
                                        </div>
                                    <% } %>

                                    <% if (item.scheduledTime && !item.sent && !item.canceled) { %>
                                        <button class="btn btn-sm btn-danger cancel-btn" data-id="<%= item.id %>">
                                            <i class="bi bi-x-circle"></i> Отменить
                                        </button>
                                    <% } %>
                                </div>
                            <% }); %>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Результат</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="/js/script.js"></script>
<script>
    // Добавляем обработчик для кнопок отмены запланированных сообщений
    document.addEventListener('DOMContentLoaded', function() {
        const historyList = document.getElementById('historyList');

        historyList.addEventListener('click', function(e) {
            if (e.target.closest('.cancel-btn')) {
                const button = e.target.closest('.cancel-btn');
                const messageId = button.dataset.id;

                if (confirm('Вы уверены, что хотите отменить запланированное сообщение?')) {
                    cancelScheduledMessage(messageId);
                }
            }
        });

        // Добавляем подсказки с временем для всех часовых поясов
        const timeElements = document.querySelectorAll('[data-utc]');
        timeElements.forEach(el => {
            const utcTime = el.getAttribute('data-utc');
            if (utcTime) {
                const date = new Date(utcTime);
                const utcString = date.toUTCString();
                const localString = date.toLocaleString();
                el.setAttribute('title', `UTC: ${utcString}\nЛокальное время: ${localString}`);
            }
        });

        async function cancelScheduledMessage(messageId) {
            try {
                const response = await fetch(`/api/cancel-scheduled/${messageId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': document.querySelector('input[name="_csrf"]').value
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('Ошибка: ' + (result.error || result.message));
                }
            } catch (error) {
                console.error('Ошибка отмены сообщения:', error);
                alert('Произошла ошибка при отмене сообщения');
            }
        }
    });
</script>
</body>
</html>